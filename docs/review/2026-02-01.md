# Code review — 2026-02-01 (NOS)

Repo: `26NOW_nonome-web` (Astro SSG, GitHub Pages)

Scope of review: **DevSecOps + maintainability**, with special attention to **today’s changes** (tap-to-expand interaction, move to Astro content collections, Pages deploy workflow, custom domain/HTTPS).

---

## Summary
The project is intentionally small and static (Astro SSG) with a clean GitHub Pages deployment. The main risks are not “runtime exploits” (there is no server) but **supply-chain / CI hardening**, **front-end security posture** (CSP/headers limitations on Pages), and a couple of maintainability hotspots introduced by the new tap-to-expand script and repeated page scaffolding.

No critical vulnerabilities were found in application logic (no user input handling, no auth, no backend). The highest-value improvements are around **CI pinning + security automation**, **content/schema tightening**, and **refactoring the card interaction script** to avoid N× document listeners and improve accessibility.

---

## P0 (must address)

### P0.1 Supply-chain hardening: GitHub Actions not pinned to commit SHAs
**Where**: `.github/workflows/deploy.yml` uses `actions/*@v4`, `upload-pages-artifact@v3`, etc.

**Risk**: If an upstream action tag is compromised, the workflow can run attacker-controlled code on your CI runner. This is a standard GitHub Actions supply-chain risk.

**Suggested fix**:
- Pin 3rd-party actions to immutable commit SHAs (and optionally keep the major tag in a comment).
- Consider using GitHub’s “Actions → Hardened” guidance (OIDC is already used correctly via `id-token: write`).

**Done when**:
- All `uses:` references in workflows are pinned to SHAs (or there is an explicit documented exception).

---

## P1 (should address soon)

### P1.1 Tap-to-expand script adds one `document.click` listener per card (scales poorly)
**Where**: `src/components/ui/Card/Card.astro`

**Risk**:
- **Maintainability/perf**: for N cards, you register N document-level click handlers. This increases memory use and can cause subtle bugs when cards are re-rendered (future dynamic islands) or if the component gets used on multiple pages.
- **Behavioral risk**: click-outside handling becomes harder to reason about with multiple listeners.

**Suggested fix** (review-only recommendation):
- Use **event delegation** with a *single* document listener (or attach one listener to the grid container), and determine the active card via `closest('[data-card]')`.
- Keep a single “open card” state and close on outside clicks.
- Consider `prefers-reduced-motion` for transitions (accessibility).

**Done when**:
- There is at most one global click listener for the card open/close behavior.
- Keyboard + pointer behavior remains correct across mobile/desktop.

### P1.2 Security headers: GitHub Pages limitations + missing CSP strategy
**Where**: overall; pages set only basic `<meta charset>` and `<meta viewport>`.

**Risk**:
- GitHub Pages does not let you set arbitrary HTTP security headers for your site in most configurations.
- Without a CSP strategy, the site’s XSS blast radius is larger than necessary (even if XSS is unlikely today, future content changes may introduce it).

**Suggested fix**:
- Decide on one:
  1) Add a **CSP via `<meta http-equiv="Content-Security-Policy">`** (works in many browsers, but not as strong as server headers), or
  2) Put the site behind a CDN/proxy that can set headers (Cloudflare, Fastly), then enforce:
     - `Content-Security-Policy` (no `unsafe-inline` if possible)
     - `Strict-Transport-Security` (HSTS)
     - `X-Content-Type-Options: nosniff`
     - `Referrer-Policy`, `Permissions-Policy`, `frame-ancestors` etc.

**Note**: The current inline `<script>` in `Card.astro` will force `unsafe-inline` unless you refactor to external JS with a nonce/hash strategy.

**Done when**:
- A documented decision exists (“CSP via meta” vs “CDN headers”), and the chosen approach is implemented.

### P1.3 Images are served via plain `<img>` with no explicit dimensions (risk of CLS + missed optimization)
**Where**: `src/components/ui/Card/Card.astro` uses `<img ... loading="lazy" />`; content provides `image: /images/...`.

**Risk**:
- Layout shift (CLS) on slower connections.
- No build-time optimization pipeline (responsive sizes, modern formats) unless handled elsewhere.

**Suggested fix**:
- If feasible, move image assets into `src/assets` and use Astro’s image pipeline (`astro:assets`) and/or `image()` validation in content collections.
- At minimum: provide `width`/`height` (or `style="aspect-ratio"` plus width) and consider `decoding="async"`.

**Done when**:
- Card images have stable layout sizing and there’s a documented approach for optimization.

### P1.4 Content collection schema is permissive for `image` and lacks constraints for `order`/`id`
**Where**: `src/content/config.ts`

**Risk**:
- Typos in image paths become runtime 404s.
- Duplicate `id` or negative/duplicated `order` leads to confusing sorting and maintenance issues.

**Suggested fix**:
- Add schema constraints:
  - `order: z.number().int().nonnegative()`
  - `id: z.string().min(1)` with a naming convention (`arch-*`, `srv-*`, …) via `regex`
  - Prefer `image: image()` (Astro content helper) if you can store images in a supported location.

**Done when**:
- Schema enforces basic invariants and CI fails fast on invalid content.

---

## P2 (nice to have / backlog)

### P2.1 Repeated HTML scaffolding across pages (head/meta/styles)
**Where**: multiple `src/pages/[lang]/*.astro` files repeat `<html>`, `<head>`, base styles.

**Impact**: higher cost to change meta tags, accessibility attributes, analytics policy, CSP meta, etc.

**Suggested fix**:
- Introduce a single layout (e.g., `BaseLayout.astro`) with:
  - Shared `<head>` (title template, canonical, social tags)
  - Shared global CSS (or a single imported stylesheet)
  - Per-page slots

### P2.2 i18n: page titles/strings not localized consistently
**Where**: `title` tags and headings are currently English/lowercase.

**Suggested fix**:
- Add a minimal dictionary and generate `<title>`/`h1` based on `lang`.

### P2.3 Add DevSecOps automation (Dependabot, CodeQL) and repository hygiene
**Suggested**:
- Dependabot for npm + GitHub Actions.
- CodeQL (JS/TS) scanning.
- Basic security policy (`SECURITY.md`) and issue templates.

---

## Risks specifically related to today’s changes

### Tap-to-expand
- Main risk is **event listener multiplication** (P1.1) and future complexity if navigation is added (“2nd tap navigates”). Decide the interaction model early (e.g., separate “open” control vs full-card link) to avoid accessibility regressions.

### Content collections
- Good direction (typed content + deterministic builds). Main risk is **schema permissiveness** (image paths, id/order invariants) and missing build-time validation for assets.

### Deploy workflow
- Workflow is minimal and correct for GitHub Pages. Main risk is **un-pinned actions** (P0.1). Consider adding dependency/security scanning and a build reproducibility check.

### Domain / HTTPS
- `public/CNAME` indicates custom domain `nonome.es`.
- Ensure GitHub Pages settings: **“Enforce HTTPS” enabled**, and DNS is correct.
- Consider adding HSTS + redirects (www → apex or vice versa). GitHub Pages alone may not cover all header needs; a CDN proxy may be required.

---

## “Done when” checklist (review acceptance)
- [ ] GitHub Actions are pinned to SHAs (or documented exceptions).
- [ ] Dependabot enabled for npm + GitHub Actions.
- [ ] CodeQL enabled (JS/TS), at least default queries.
- [ ] A documented decision exists for security headers/CSP on GitHub Pages (meta vs CDN).
- [ ] Card interaction uses single delegated listeners (no per-card `document` listeners).
- [ ] Card interaction passes basic accessibility checks (keyboard, focus visible, `aria-expanded` matches visibility).
- [ ] Image strategy documented and implemented (dimensions + optimization plan).
- [ ] Content schema tightened (order/id/image validation).

---

## Ordered hardening backlog (10–20 items)
1. **Pin GitHub Actions to commit SHAs** in `.github/workflows/deploy.yml`.
2. Add **Dependabot** config for `npm` and `github-actions`.
3. Add **CodeQL** workflow for JS/TS.
4. Add a short **SECURITY.md** (reporting policy) + confirm GitHub security features enabled (secret scanning, dependency graph).
5. Decide and implement **CSP strategy** (meta CSP vs CDN/proxy headers). Document it in `docs/hosting.md` or similar.
6. Refactor **Card tap-to-expand** to single delegated click + keydown handlers; add `prefers-reduced-motion` support.
7. Add **focus-visible styling** (and confirm keyboard navigation across cards) to avoid hidden focus states.
8. Implement an **image pipeline**: switch to `astro:assets` where possible; otherwise add explicit dimensions and modern formats.
9. Tighten **content collection schema** (`order` nonnegative, `id` naming convention, `image()` if supported).
10. Add **CI checks**: `npm ci`, `npm run build`, and optionally `npm audit --production` (or `npm audit --omit=dev`) with agreed policy.
11. Add **link and asset checks** in CI (e.g., broken internal links, missing images referenced by content).
12. Create a **BaseLayout** to centralize meta tags and shared styles.
13. Add **canonical URLs** and set `site` in `astro.config.mjs` (helps SEO and consistency on custom domain).
14. Add minimal **i18n dictionary** for titles/headings and ensure routes have consistent language handling.
15. Add **robots.txt / sitemap** decision (Astro integration) based on launch readiness.

