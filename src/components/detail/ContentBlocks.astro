---
import type { Lang } from '../../lib/i18n/i18n';
import { fallbackText } from '../../lib/i18n/i18n';
import { marked } from 'marked';

type LocalizedText = { es: string; en?: string };

type TextBlock = { type: 'text'; markdown: string };
type ImageBlock = { type: 'image'; src: string; alt?: string; caption?: LocalizedText };
type VideoBlock = { type: 'video'; src: string; poster?: string; caption?: LocalizedText };
export type ContentBlock = TextBlock | ImageBlock | VideoBlock;

const { lang, blocks, Content } = Astro.props as {
  lang: Lang;
  blocks?: ContentBlock[];
  Content?: any;
};

function renderMarkdown(md: string) {
  // Minimal markdown support for authored content blocks.
  // Note: this does not sanitize HTML. Keep authored markdown trusted.
  return marked.parse(md ?? '', { breaks: true }) as string;
}
---

<section class="content" aria-label="Content">
  {blocks?.length ? (
    <div class="blocks">
      {blocks.map((b) => {
        if (b.type === 'text') {
          return <div class="block text" set:html={renderMarkdown(b.markdown)} />;
        }

        if (b.type === 'image') {
          const caption = b.caption ? fallbackText(b.caption, lang) : undefined;
          return (
            <figure class="block image">
              <img class="img" src={b.src} alt={b.alt ?? ''} loading="lazy" />
              {caption ? <figcaption class="caption">{caption}</figcaption> : null}
            </figure>
          );
        }

        // video
        const caption = b.caption ? fallbackText(b.caption, lang) : undefined;
        return (
          <figure class="block video">
            <video class="videoEl" controls playsinline poster={b.poster}>
              <source src={b.src} />
            </video>
            {caption ? <figcaption class="caption">{caption}</figcaption> : null}
          </figure>
        );
      })}
    </div>
  ) : Content ? (
    <article class="markdown">
      <Content />
    </article>
  ) : null}
</section>

<style>
  .content{margin:18px 0 0;}
  .blocks{display:flex;flex-direction:column;gap:14px;}
  .block{margin:0;}
  .img,.videoEl{width:100%;height:auto;display:block;border-radius:10px;}
  .caption{margin:8px 2px 0;opacity:.7;font-size:12px;}
  .markdown{opacity:.92;line-height:1.55;}
  .text{opacity:.92;line-height:1.55;}
  .text :global(p){margin:0 0 10px;}
  .text :global(p:last-child){margin-bottom:0;}
  .text :global(ul),.text :global(ol){margin:0 0 10px 18px;}
  .text :global(h2),.text :global(h3){margin:12px 0 8px;font-size:14px;letter-spacing:.02em;text-transform:lowercase;}
  .text :global(code){background:rgba(0,0,0,.06);padding:2px 4px;border-radius:4px;}
  .text :global(pre){background:rgba(0,0,0,.06);padding:10px 12px;border-radius:10px;overflow:auto;}
</style>
