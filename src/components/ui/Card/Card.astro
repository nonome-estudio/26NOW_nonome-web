---
import styles from './Card.module.css';
import type { CardProps } from './Card.types';

const { title, description, imageSrc, imageAlt } = Astro.props as CardProps;
---

<article class={styles.card} tabindex="0" role="button" aria-expanded="false" data-card data-open="false">
  {imageSrc ? <img class={styles.img} src={imageSrc} alt={imageAlt ?? ''} loading="lazy" /> : null}

  <div class={styles.body}>
    <div class={styles.title}>{title}</div>
    {description ? <div class={styles.desc}>{description}</div> : null}
  </div>
</article>

<script>
  // Mobile/touch behavior:
  // - 1st tap: select/expand (reveal description)
  // - 2nd tap: reserved for future "enter" behavior (v2)
  (() => {
    // We implement tap-to-expand using a data attribute so it works consistently
    // across devices/browsers (some mobile browsers report hover capabilities).
    const cards = Array.from(document.querySelectorAll('[data-card]'));

    function closeAll(except) {
      for (const el of cards) {
        if (el !== except) {
          el.setAttribute('data-open', 'false');
          el.setAttribute('aria-expanded', 'false');
        }
      }
    }

    for (const el of cards) {
      el.addEventListener('click', (e) => {
        // v1: no navigation, so a click becomes a "select/expand" interaction.
        const isOpen = el.getAttribute('data-open') === 'true';
        if (!isOpen) {
          e.preventDefault();
          closeAll(el);
          el.setAttribute('data-open', 'true');
          el.setAttribute('aria-expanded', 'true');
        } else {
          // v2: navigate to detail. For v1 keep it selected.
          e.preventDefault();
          el.setAttribute('data-open', 'true');
          el.setAttribute('aria-expanded', 'true');
        }
      }, { passive: false });

      // Tap/click outside closes.
      document.addEventListener('click', (evt) => {
        const t = evt.target;
        if (!(t instanceof Node)) return;
        if (!el.contains(t)) {
          el.setAttribute('data-open', 'false');
          el.setAttribute('aria-expanded', 'false');
        }
      });

      // Keyboard: Enter/Space toggles open state.
      el.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter' && e.key !== ' ') return;
        e.preventDefault();
        const isOpen = el.getAttribute('data-open') === 'true';
        closeAll(el);
        el.setAttribute('data-open', (!isOpen).toString());
        el.setAttribute('aria-expanded', (!isOpen).toString());
      });
    }
  })();
</script>
